### ESP32-S3 计算器项目功能修改建议

> 说明：本文档整理了上一轮评审中提出的所有代码修改与优化方案，分为功能目标、修改要点、具体代码位置示例以及测试用例四个部分，供后续开发实现与验证。

---

## 一、功能目标
1. **数值格式统一**：所有结果和历史记录采用智能格式化，整数显示为整数，小数显示最多3位小数并去尾零，采用"四舍五入"规则。
2. **消除重复显示**：当没有新的计算结果产生时，避免"表达式区"与"历史记录区"显示相同内容。
3. **刷新优化**：仅在历史记录实际增加时刷新对应显示区域，减少屏闪。
4. **通用取整工具**：提供一个 `roundTo(value, decimals)` 工具函数，用于所有浮点数截取，防止精度误差。

---

## 二、修改要点与代码位置
| # | 目标 | 主要改动文件 | 关键行号/函数 | 改动概要 |
|---|------|--------------|---------------|----------|
|1|小数点后三位四舍五入|`src/CalculatorCore.cpp`|`formatNumber`|1️⃣ 先执行 `number = round(number*1000)/1000` → 2️⃣ 改 `String(number, 6)` 为 `String(number, 3)`|
|2|历史记录智能格式化|`src/CalcDisplayAdapter.h`（实现位于头文件内联）|`updateDisplay`|使用统一的NumberFormatter::format()替换固定小数位显示|
|3|表达式区去重复（方案 A）|`src/CalculatorCore.cpp`|"=" 处理分支|将 `_expressionDisplay` 置空，结果仅显示于结果行|
| |表达式区去重复（方案 B）|同上|同上|只在表达式行保留"公式"，历史行加"=结果"|
|4|历史刷新优化|`src/CalcDisplayAdapter.h`|`updateDisplay`|仅当 `history.size() > _lastHistorySize` 时才调用 `updateHistoryDirect`|
|5|NumberFormatter工具类|新增 `utils/NumberFormatter.h`|创建独立的NumberFormatter类，禁止在CalculatorCore内重复实现|

> ✅ **方案选择**：本阶段采用**方案 B**为唯一实现方向（表达式行保留公式显示），提供更好的用户体验。

---

## 三、示例代码片段
以下仅列出关键修改片段，完整 diff 见实际提交：
```cpp
// 510:530:src/CalculatorCore.cpp  
String result = NumberFormatter::format(number);  // 使用统一格式化
```

```cpp
// 28:38:src/CalcDisplayAdapter.h
newLatest = latest.expression + "=" + NumberFormatter::format(latest.result);
......
newOlder  = older .expression + "=" + NumberFormatter::format(older .result);
```

```cpp
// 560:570:src/CalculatorCore.cpp  （方案 A 示例）
_currentDisplay    = formatNumber(result); // 结果行
_expressionDisplay = "";                  // 清空表达式行
```

---

## 四、测试用例与预期结果
1. **计算 1+2=**  
   - 结果行：`3`  
   - 历史行：`1+2=3`  
   - 表达式行：`1+2`（方案B）
2. **随后计算 5/8=**  
   - 结果行：`0.625`  
   - 历史行：
     1) `5/8=0.625`  
     2) `1+2=3`
   - 表达式行：`5/8`（方案B）

> 若结果与以上预期一致，说明本轮修改已生效。 