# 计算器 UI 动效边界条件补充文档

> 版本：v1.0  
> 关联文档：`动效实现指导.md` (v1.0)  
> 本文档旨在补充和明确在实现 `动效实现指导.md` 中定义的 UI 动画时，需要特别关注的边界条件（Edge Cases），以确保动效系统的健壮性和用户体验的流畅性。

---

## 核心原则

在处理边界条件时，应遵循以下核心原则：

1.  **用户输入优先**：系统应始终能即时响应用户的最新操作，不应被正在播放的动画阻塞。
2.  **状态即时性**：动画的目的是增强视觉表现，但不应延迟真实状态的更新。动画可以被中断或跳过，以确保屏幕显示的内容始终与核心计算逻辑的状态保持一致。
3.  **视觉无冲突**：避免多个动画效果在同一区域同时发生而导致的视觉混乱。

---

## 边界条件分析与建议策略

### 1. 动画冲突与快速输入处理

这是最关键的一类边界条件，源于用户的操作速度快于动画的播放速度。

| 场景 | 边界问题描述 | 建议策略 |
| :--- | :--- | :--- |
| **快速连续输入/删除**<br>(A1/A2) | 用户输入或删除字符的速度快于单个字符的滑入/滑出动画时长。 | **立即结束旧动画，开始新动画**。若新动画请求（如输入'2'）到达时，前一个（输入'1'）还在播放，应立即将'1'渲染到最终位置，然后立即开始'2'的滑入动画。避免动画队列堆积造成延迟感。 |
| **快速切换运算符**<br>(B) | 用户输入数字后，快速按下 `+`，紧接着又按下 `×`。数字上移动画（B）可能尚未完成。 | **中断并更新**。动画应被后续的运算符输入中断。例如，`+` 触发的上移动画在播放时若接收到 `×`，应立即停止，并将表达式区的 `+` 直接更新为 `×`。 |
| **计算与历史滚动冲突**<br>(C) | 用户按 `=` 后，表达式开始向上滚动进入历史区。此时用户再次按 `=` 或输入新数字。 | **中断并响应新操作**。任何新的输入或计算指令都应中断“滚动入历史”动画。系统应立即处理新指令，例如执行新的计算或开始新的输入动画。 |
| **动画过程中的 CLEAR**<br>(D1/D2) | 在任何动画（如 A, B, C）播放到一半时，用户按下了 `CLEAR` 键。 | **`CLEAR` 拥有最高优先级**。它必须能立即中断任何正在播放的动画，并立刻开始执行 `CLEAR` 自身的滑出动画（D1 或 D2），以提供最快、最明确的反馈。 |

### 2. 文本溢出屏幕

当输入或表达式的长度超过屏幕可显示宽度时，动画表现需要特殊处理。

| 场景 | 边界问题描述 | 建议策略 |
| :--- | :--- | :--- |
| **长文本输入/删除**<br>(A1/A2) | 当输入区的文本已溢出时，新字符的“滑入”和被删除字符的“滑出”动画如何表现？ | **在可见区域内执行动画**。滑入的字符应从屏幕右边缘滑入到可见区域的末尾。被删除的字符（如果可见）应从其当前位置向右滑出屏幕。如果操作的字符在屏幕外，可以考虑不播放动画，仅更新文本并滚动。 |
| **长表达式上移/滚动**<br>(B/C) | 一个需要滚动才能完全显示的超长表达式，在执行上移动画或滚入历史区时，其动画表现会很复杂。 | **简化为静态更新或整体移动**。对于溢出的长文本，复杂的逐字符动画可能会产生混乱。建议简化处理：可以先不播放动画，直接将文本更新到目标区域；或者将整个文本区域视为一个整体，进行平移和缩放，而不是处理内部字符。 |

### 3. 特殊状态与空状态

对特殊值（如 "0"）或空状态的操作也需要明确定义。

| 场景 | 边界问题描述 | 建议策略 |
| :--- | :--- | :--- |
| **对 "0" 的操作** | 当前输入为 "0" 时，按下运算符（如 `+`），是否执行 "0" 上移的动画（B）？ | **遵循计算逻辑，避免无效动画**。多数计算器逻辑会忽略前导 "0" 的输入。因此，当输入为 "0" 时按运算符，不应触发上移动画。表达式区应保持不变，等待用户输入有效的第一个数字。 |
| **历史记录为空** | 当历史记录区为空时，第一个表达式滚入历史（C）的动画表现是否需要特殊处理？ | **动画表现应一致**。即使历史区为空，表达式也应从 `lines[2]` 的位置向上滚动到 `lines[1]` 的位置。`lines[0]` 保持空白即可。 |
| **历史记录区满** | 当 `lines[0]` 和 `lines[1]` 都已有内容时，新的历史记录滚入时，最老的历史（`lines[0]`）如何消失？ | **增加“滑出”动画**。为保持视觉连续性，`lines[0]` 的内容应伴随 `lines[1]` 和 `lines[2]` 的上滚，继续向上滑出屏幕直至消失。这能提供一个完整的“先进先出”队列的视觉隐喻。 |

---

## 实现建议

为有效处理以上边界条件，建议在 `CalcDisplay` 或动画控制模块中实现一个统一的 **动画管理器**。

该管理器应具备以下功能：
- **动画队列或状态机**：管理当前正在播放的动画。
- **中断逻辑**：提供一个 `interrupt()` 方法，可以被高优先级的操作调用，以强制停止当前动画并清理状态。
- **状态快照**：在动画开始前捕获起始状态，在需要时可以立即“跳”到动画的结束状态。

通过这种方式，可以从底层确保动效系统的稳定性和响应性，使其在各种复杂和快速的用户交互场景下都能表现得优雅而正确。
