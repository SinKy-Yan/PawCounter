# P1é˜¶æ®µæŠ€æœ¯æ¶æ„æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0  
> **å®Œæˆæ—¥æœŸ**: 2025-07-01  
> **æ¶æ„é˜¶æ®µ**: P1 - éé˜»å¡åŠ¨ç”»ç®¡ç†æ¶æ„  

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®¡ç®—å™¨åŠ¨ç”»ç³»ç»Ÿ P1æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  main.cpp (loop)                                           â”‚
â”‚    â†“                                                       â”‚
â”‚  CalcDisplay::tick()                                       â”‚
â”‚    â†“                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ AnimationManagerâ”‚    â”‚PerformanceMonitorâ”‚               â”‚
â”‚  â”‚   - é˜Ÿåˆ—ç®¡ç†     â”‚    â”‚   - FPSç»Ÿè®¡     â”‚                â”‚
â”‚  â”‚   - ä¼˜å…ˆçº§      â”‚    â”‚   - è‡ªåŠ¨é™çº§    â”‚                â”‚
â”‚  â”‚   - å¹¶å‘æ§åˆ¶     â”‚    â”‚   - æ€§èƒ½ç›‘æ§    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚    â†“                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚CharSlideAnimâ”‚  â”‚MoveToExprAnimâ”‚  â”‚Future Anims â”‚         â”‚
â”‚  â”‚  (A1/A2)    â”‚  â”‚    (B)      â”‚  â”‚   (C/D)     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚    â†“                â†“                â†“                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”‚              CalcDisplay ç»˜åˆ¶å±‚                         â”‚
â”‚  â”‚  - startWrite/endWriteæ‰¹é‡æ“ä½œ                          â”‚
â”‚  â”‚  - é˜²é—ªçƒæ ¸å¿ƒå®ç°                                        â”‚
â”‚  â”‚  - LCDç¡¬ä»¶æŠ½è±¡                                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶

### 1. AnimationManager (åŠ¨ç”»ç®¡ç†å™¨)
**èŒè´£**: ç»Ÿä¸€ç®¡ç†æ‰€æœ‰åŠ¨ç”»çš„ç”Ÿå‘½å‘¨æœŸ

```cpp
class AnimationManager {
private:
    std::vector<Animation*> _activeAnimations;    // æ´»è·ƒåŠ¨ç”»
    std::vector<Animation*> _pendingAnimations;   // ç­‰å¾…é˜Ÿåˆ—
    uint8_t _maxConcurrentAnimations;            // æœ€å¤§å¹¶å‘æ•°
    unsigned long _frameInterval;                 // å¸§é—´éš”
    
public:
    bool addAnimation(Animation* animation, bool autoStart = true);
    void interruptAnimations(AnimationPriority minPriority);
    uint8_t tick();  // æ ¸å¿ƒæ›´æ–°å¾ªç¯
};
```

**å…³é”®ç®—æ³•**:
1. **ä¼˜å…ˆçº§æŠ¢å **: é«˜ä¼˜å…ˆçº§åŠ¨ç”»å¯ä¸­æ–­ä½ä¼˜å…ˆçº§
2. **é˜Ÿåˆ—ç®¡ç†**: è¶…å‡ºå¹¶å‘é™åˆ¶æ—¶è¿›å…¥ç­‰å¾…é˜Ÿåˆ—
3. **èµ„æºç®¡ç†**: è‡ªåŠ¨æ¸…ç†å®Œæˆçš„åŠ¨ç”»å¯¹è±¡

### 2. PerformanceMonitor (æ€§èƒ½ç›‘æ§å™¨)
**èŒè´£**: ç›‘æ§ç³»ç»Ÿæ€§èƒ½å¹¶æä¾›è‡ªåŠ¨é™çº§å»ºè®®

```cpp
class PerformanceMonitor {
private:
    float _currentFPS;                           // å½“å‰å¸§ç‡
    unsigned long _frameTime;                    // å¸§è€—æ—¶
    float _cpuUsage;                            // CPUä½¿ç”¨ç‡
    PerformanceLevel _currentLevel;             // æ€§èƒ½ç­‰çº§
    
public:
    void beginFrame() / endFrame();             // å¸§ç›‘æ§
    void update(uint8_t activeAnimations);      // æ€§èƒ½æ›´æ–°
    bool shouldReduceAnimations();              // é™çº§å†³ç­–
};
```

**æ€§èƒ½ç­‰çº§ç­–ç•¥**:
```cpp
PERFORMANCE_HIGH:    20FPS, 3å¹¶å‘åŠ¨ç”»
PERFORMANCE_MEDIUM:  16FPS, 2å¹¶å‘åŠ¨ç”»
PERFORMANCE_LOW:     10FPS, 1å¹¶å‘åŠ¨ç”»
PERFORMANCE_CRITICAL: 6FPS, 0å¹¶å‘åŠ¨ç”»
```

### 3. AnimationåŸºç±»æ¶æ„
**æ”¹è¿›**: ä»P0é˜¶æ®µçš„é˜»å¡å¼æ”¹ä¸ºéé˜»å¡å¼

```cpp
class Animation {
protected:
    AnimationState _state;                      // åŠ¨ç”»çŠ¶æ€
    AnimationPriority _priority;                // ä¼˜å…ˆçº§
    unsigned long _startTime, _duration;       // æ—¶é—´æ§åˆ¶
    
public:
    virtual void start();                       // å¼€å§‹åŠ¨ç”»
    virtual bool tick();                        // éé˜»å¡æ›´æ–°
    virtual void interrupt();                   // ä¸­æ–­å¤„ç†
    virtual void renderFrame(float progress) = 0; // çº¯è™šå‡½æ•°
};
```

**çŠ¶æ€æœº**:
```
IDLE â†’ start() â†’ PLAYING â†’ tick() â†’ COMPLETED
                     â†“ interrupt()
                 INTERRUPTED
```

## ğŸ”§ å…³é”®æŠ€æœ¯å®ç°

### 1. é˜²é—ªçƒæ‰¹é‡æ“ä½œ
**æ ¸å¿ƒåŸç†**: SPIæ€»çº¿æ‰¹é‡ä¼ è¾“é¿å…ä¸­é—´çŠ¶æ€æ˜¾ç¤º

```cpp
void CharSlideAnim::renderFrame(float progress) {
    tft->startWrite();          // â˜… å¼€å§‹æ‰¹é‡ä¼ è¾“
    
    // 1. æ¸…é™¤åŒºåŸŸ
    tft->fillRect(x, y, w, h, COLOR_BG);
    
    // 2. ç»˜åˆ¶é™æ€æ–‡æœ¬
    tft->setTextColor(color);
    tft->setCursor(x, y);
    tft->print(staticText);
    
    // 3. ç»˜åˆ¶åŠ¨æ€å†…å®¹
    tft->setCursor(movingX, y);
    tft->print(movingChar);
    
    tft->endWrite();            // â˜… ç»“æŸæ‰¹é‡ä¼ è¾“
}
```

**æ•ˆæœ**: LCDä¸€æ¬¡æ€§æ˜¾ç¤ºæœ€ç»ˆç»“æœï¼Œæ¶ˆé™¤"é»‘â†’ç™½"é—ªçƒ

### 2. éé˜»å¡æ—¶é—´æ§åˆ¶
**P0é—®é¢˜**: `delay(1000/fps)` é˜»å¡æ•´ä¸ªç³»ç»Ÿ
**P1è§£å†³**: `millis()` åŸºå‡†çš„éé˜»å¡æ—¶é—´æ§åˆ¶

```cpp
uint8_t AnimationManager::tick() {
    unsigned long currentTime = millis();
    
    // å¸§ç‡æ§åˆ¶ - éé˜»å¡
    if (currentTime - _lastTickTime < _frameInterval) {
        return _activeAnimations.size();  // è¿˜æ²¡åˆ°ä¸‹ä¸€å¸§
    }
    
    // æ›´æ–°æ‰€æœ‰æ´»è·ƒåŠ¨ç”»
    for (auto* anim : _activeAnimations) {
        bool continueAnim = anim->tick();
        if (!continueAnim) {
            // æ¸…ç†å®Œæˆçš„åŠ¨ç”»
        }
    }
}
```

### 3. æ™ºèƒ½èµ„æºç®¡ç†
**å†…å­˜ç®¡ç†ç­–ç•¥**:
```cpp
// åˆ›å»ºæ—¶
Animation* newAnim = new CharSlideAnim(...);
_animationManager->addAnimation(newAnim, true);

// è‡ªåŠ¨æ¸…ç†
if (!continueAnimation) {
    delete anim;  // AnimationManagerè´Ÿè´£æ¸…ç†
    anim = nullptr;
}
```

**ä¼˜å…ˆçº§æŠ¢å ç®—æ³•**:
```cpp
bool AnimationManager::addAnimation(Animation* animation, bool autoStart) {
    if (_activeAnimations.size() >= _maxConcurrentAnimations) {
        // å¯»æ‰¾æœ€ä½ä¼˜å…ˆçº§åŠ¨ç”»
        Animation* lowestPriorityAnim = findLowestPriority();
        
        if (animation->getPriority() > lowestPriorityAnim->getPriority()) {
            // æŠ¢å ä½ä¼˜å…ˆçº§åŠ¨ç”»
            interruptAndReplace(lowestPriorityAnim, animation);
            return true;
        }
        
        // åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
        _pendingAnimations.push_back(animation);
        sortByPriority(_pendingAnimations);
    }
}
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### åŠ¨ç”»è§¦å‘æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ KeypadControl â†’ CalculatorCore â†’ CalcDisplayAdapter
    â†“
çŠ¶æ€å·®å¼‚æ£€æµ‹ â†’ è§¦å‘ç›¸åº”åŠ¨ç”»
    â†“
AnimationManager::addAnimation() â†’ ä¼˜å…ˆçº§åˆ¤æ–­ â†’ é˜Ÿåˆ—ç®¡ç†
    â†“
Animation::start() â†’ renderFrame() â†’ LCDæ˜¾ç¤º
```

### æ€§èƒ½ç›‘æ§æµç¨‹
```
CalcDisplay::tick() â†’ PerformanceMonitor::beginFrame()
    â†“
AnimationManager::tick() â†’ åŠ¨ç”»æ›´æ–°
    â†“
PerformanceMonitor::endFrame() â†’ æ€§èƒ½ç»Ÿè®¡
    â†“
è‡ªåŠ¨é™çº§å†³ç­– â†’ AnimationManagerè°ƒå‚
```

## ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†ä¸å®¹é”™

### 1. åŠ¨ç”»ä¸­æ–­å¤„ç†
```cpp
void AnimationManager::interruptAnimations(AnimationPriority minPriority) {
    for (auto it = _activeAnimations.begin(); it != _activeAnimations.end();) {
        if ((*it)->getPriority() < minPriority) {
            (*it)->interrupt();      // è°ƒç”¨åŠ¨ç”»çš„ä¸­æ–­å¤„ç†
            delete *it;              // æ¸…ç†èµ„æº
            it = _activeAnimations.erase(it);
        } else {
            ++it;
        }
    }
}
```

### 2. å†…å­˜æ³„æ¼é˜²æŠ¤
```cpp
AnimationManager::~AnimationManager() {
    // æ¸…ç†æ‰€æœ‰æ´»è·ƒåŠ¨ç”»
    for (Animation* anim : _activeAnimations) {
        delete anim;
    }
    
    // æ¸…ç†ç­‰å¾…é˜Ÿåˆ—
    for (Animation* anim : _pendingAnimations) {
        delete anim;
    }
}
```

### 3. æ€§èƒ½é™çº§ä¿æŠ¤
```cpp
void PerformanceMonitor::updatePerformanceLevel() {
    if (_currentFPS < _minAcceptableFPS) {
        _levelDowngradeCount++;
    }
    
    // è¿ç»­3æ¬¡æ‰é™çº§ï¼Œé˜²æ­¢æŠ–åŠ¨
    if (_levelDowngradeCount >= 3) {
        _currentLevel = (PerformanceLevel)(_currentLevel + 1);
        // é€šçŸ¥AnimationManagerè°ƒæ•´å‚æ•°
    }
}
```

## ğŸ“ è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. ç®¡ç†å™¨æ¨¡å¼ (Manager Pattern)
- **AnimationManager**: ç»Ÿä¸€ç®¡ç†åŠ¨ç”»ç”Ÿå‘½å‘¨æœŸ
- **PerformanceMonitor**: ç»Ÿä¸€ç®¡ç†æ€§èƒ½ç›‘æ§

### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)
- **PerformanceLevel**: ä¸åŒæ€§èƒ½ç­‰çº§çš„ç­–ç•¥
- **AnimationPriority**: ä¸åŒä¼˜å…ˆçº§çš„å¤„ç†ç­–ç•¥

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)
- **PerformanceMonitor â†’ AnimationManager**: æ€§èƒ½å˜åŒ–é€šçŸ¥
- **CalcDisplayAdapter â†’ AnimationManager**: çŠ¶æ€å˜åŒ–è§¦å‘

### 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)
- **AnimationåŸºç±»**: å®šä¹‰åŠ¨ç”»æ‰§è¡Œæ¨¡æ¿
- **å…·ä½“åŠ¨ç”»ç±»**: å®ç°ç‰¹å®šçš„æ¸²æŸ“é€»è¾‘

## ğŸ”§ é…ç½®ä¸æ‰©å±•

### ç¼–è¯‘æ—¶é…ç½®
```cpp
// config.h
#define ENABLE_ANIMATIONS 1                    // å¯ç”¨åŠ¨ç”»ç³»ç»Ÿ
#define ANIMATION_DEFAULT_FPS 12               // é»˜è®¤å¸§ç‡
#define MAX_CONCURRENT_ANIMATIONS 3            // æœ€å¤§å¹¶å‘æ•°
#define ENABLE_PERFORMANCE_MONITOR 0           // æ€§èƒ½ç›‘æ§å¼€å…³
```

### è¿è¡Œæ—¶é…ç½®
```cpp
// åŠ¨æ€è°ƒæ•´å¸§ç‡
_animationManager->setTargetFPS(newFPS);

// åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°
_animationManager->setMaxConcurrentAnimations(maxCount);

// æ€§èƒ½ç›‘æ§æ§åˆ¶
_performanceMonitor->setTargetFPS(targetFPS);
```

### æ‰©å±•æ–°åŠ¨ç”»
```cpp
class NewAnim : public Animation {
public:
    NewAnim(CalcDisplay* display, /* params */) 
        : Animation(display, duration, priority, fps) {}
        
protected:
    void renderFrame(float progress) override {
        // å®ç°å…·ä½“çš„åŠ¨ç”»é€»è¾‘
        _display->tft->startWrite();
        // ... ç»˜åˆ¶æ“ä½œ
        _display->tft->endWrite();
    }
};

// ä½¿ç”¨
_animationManager->addAnimation(new NewAnim(...), true);
```

## ğŸ“Š æ€§èƒ½ç‰¹å¾

### å†…å­˜å ç”¨
- **é™æ€å†…å­˜**: ~2KB ä»£ç æ®µ
- **åŠ¨æ€å†…å­˜**: <500å­—èŠ‚ (3ä¸ªå¹¶å‘åŠ¨ç”»)
- **æ€»å ç”¨**: 7.5% RAM, 22.6% Flash

### æ—¶é—´å¤æ‚åº¦
- **æ·»åŠ åŠ¨ç”»**: O(n) (n=å¹¶å‘æ•°,æœ€å¤§3)
- **tickæ›´æ–°**: O(n) (n=æ´»è·ƒåŠ¨ç”»æ•°)
- **ä¼˜å…ˆçº§æŠ¢å **: O(n) (n=æ´»è·ƒåŠ¨ç”»æ•°)

### å“åº”æ€§èƒ½
- **æŒ‰é”®å“åº”**: éé˜»å¡ï¼Œ<1ms
- **åŠ¨ç”»å»¶è¿Ÿ**: 83ms (12FPS)
- **ç³»ç»Ÿå¼€é”€**: <15% CPU

## ğŸ”® æ¶æ„ä¼˜åŠ¿ä¸é™åˆ¶

### âœ… ä¼˜åŠ¿
1. **éé˜»å¡**: ç³»ç»Ÿå“åº”æ€§ä¼˜ç§€
2. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°åŠ¨ç”»ç±»å‹
3. **é«˜æ•ˆ**: æ‰¹é‡æ“ä½œå‡å°‘é—ªçƒ
4. **æ™ºèƒ½**: è‡ªåŠ¨æ€§èƒ½è°ƒèŠ‚
5. **ç¨³å®š**: å®Œå–„çš„å¼‚å¸¸å¤„ç†

### âš ï¸ é™åˆ¶
1. **å¹¶å‘æ•°é™åˆ¶**: æœ€å¤§3ä¸ªåŠ¨ç”»
2. **å¤æ‚åº¦é™åˆ¶**: ç®€å•åŠ¨ç”»ä¸ºä¸»
3. **ç¡¬ä»¶ä¾èµ–**: ä¾èµ–Arduino_GFX
4. **å†…å­˜çº¦æŸ**: ESP32å†…å­˜é™åˆ¶

### ğŸ”§ æ”¹è¿›æ–¹å‘
1. **P2é˜¶æ®µ**: å®ç°C/Dç³»åˆ—å¤æ‚åŠ¨ç”»
2. **æ€§èƒ½ä¼˜åŒ–**: PerformanceMonitoré‡æ„
3. **ç¡¬ä»¶åŠ é€Ÿ**: è€ƒè™‘DMAä¼ è¾“
4. **æµ‹è¯•å®Œå–„**: è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

è¿™ä¸ªæ¶æ„ä¸ºåŠ¨ç”»ç³»ç»Ÿæä¾›äº†åšå®çš„åŸºç¡€ï¼Œæ—¢ä¿è¯äº†å½“å‰åŠŸèƒ½çš„ç¨³å®šæ€§ï¼Œåˆä¸ºæœªæ¥æ‰©å±•é¢„ç•™äº†å……è¶³çš„ç©ºé—´ã€‚