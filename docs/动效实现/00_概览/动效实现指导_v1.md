# 计算器 UI 动效实施指导

> 版本：v1.0  
> 最近更新：2025-07-01  
> 适用代码基：`CalcDisplay` + `CalcDisplayAdapter` + `CalculatorCore`

---

## 动效总览

| 编号 | 动效场景 | 描述 | 触发条件 |
| ---- | -------- | ---- | -------- |
| A1   | 输入字符滑入 | 新输入的数字/小数点由右侧滑入输入区 | `INPUT_NUMBER`，`mainText` 长度 +1 |
| A2   | 删除字符滑出 | 被删除的字符向右滑出输入区 | DELETE、Backspace 按键 |
| B    | 输入转表达式 | 当前数字上移并缩小，落入表达式区 | 用户按运算符 `+ − × ÷` |
| C    | 表达式滚入历史 | 完整表达式向上滚动并加入历史区 | 用户按 `=` 计算完成 |
| D1   | 清除输入 | 若表达式区有内容，仅输入区内容向左滑出并渐现 `0` | CLEAR 按键且表达式不为空 |
| D2   | 清除表达式 | 若输入区已为空，表达式区内容向左滑出清空 | CLEAR 按键且输入已清空 |

---

## 技术原则

1. **非阻塞动画**：优先采用 `millis()` 节拍，在主循环中调用 `display.tick()` 推进帧。
2. **局部刷新**：用 `tft->fillRect()` 擦除最小区域，减少闪屏。
3. **差异检测**：`CalcDisplayAdapter` 比较旧/新文本，仅在真正变化时调度动画。
4. **时间基准**：短动画 120-250 ms；帧数 6-12 帧；帧间隔 ≈20 ms。

---

## 动效实现细节

### A. 输入区字符滑入/滑出

- **字符宽**：`cw = 6 * textSize`（5px 字符 +1px 间隔）。
- **插入**：起点 `x = screenWidth` → 终点 `x = PAD_X + cw * (旧字符数)`。
- **删除**：起点 `x = PAD_X + cw * (新字符数)` → 终点 `x = screenWidth`。
- **步骤**：
  1. 擦除行区域 `clearLine(3)`。
  2. 重绘静止文本 → 绘制运动中字符 → `delay/frame` or `tick`。

### B. 数字上移并缩小到表达式区

| 参数 | 起始 | 目标 |
| ---- | ---- | ---- |
| 字号 | `size0 = lines[3].textSize` (8) | `size1 = lines[2].textSize` (3) |
| Y    | `y0 = lines[3].y` | `y1 = lines[2].y` |

- 表达式区先绘制 _suffix_（运算符）；移动中的数字单独插值位置/字号。
- 结束后：`updateExprDirect(finalExpr)`，`updateResultDirect("0")`。

### C. 表达式区滚动进入历史记录

1. 调用 `pushHistory()` 前，暂存 `lines[1]`（旧最新历史）。
2. **滚动动画**：在 2-3 帧内同时降低 `lines[1].y`→`lines[0].y`，`lines[2].y`→`lines[1].y`。
3. 结束后按现逻辑更新文本并重置 y 坐标。

### D. CLEAR 动效

#### D1. 仅清除输入区

- 判断：`expression != "" && (inputText != "0" && inputText != "")`。
- **动画**：输入区文本从 `PAD_X` 开始向左移动至 `x = -textWidth`，透明度同时 0→100%（简单实现可先滑出再直接写入 "0" 渐显）。
- 渐显方案：额外 3 帧，以 `tft->setTextColor(color, alpha)` 实现，若驱动不支持透明就逐帧闪烁淡入。

#### D2. 清除表达式区

- 条件：输入区已是 `"0"` 或空。
- **动画**：表达式区整行文本向左滑出 (`x = PAD_X` → `x = -textWidth`)；结束后清空表达式字符串。

---

## 模块接口建议

```cpp
class CalcDisplay {
  public:
    void tick();
    void animateInputChange(const String& oldTxt, const String& newTxt);   // A1/A2
    void animateMoveInputToExpr(const String& inputTxt, const String& finalExpr); // B
    void animateExprToHistory(const String& expr, const String& latestHist, const String& olderHist); // C
    void animateClear(bool onlyInput); // D1 / D2
};
```

`CalcDisplayAdapter` 负责根据状态调用以上接口：

```cpp
if (clearPressed) {
    bool onlyInput = !expression.isEmpty();
    display->animateClear(onlyInput);
    return;
}
```

---

## 集成流程

1. **添加动画 API** → `CalcDisplay`。（初版可阻塞 `delay()`，确认效果后改 `tick()`）。
2. **Adapter 差异检测** → 触发 A/B/C/D 对应 API。
3. **功能验证**：
   - 连续数字输入、删除；
   - 快速运算符切换；
   - 反复 `=` 生成历史；
   - 两次 CLEAR 的不同表现。
4. 性能测试：CPU 占用、帧丢失；必要时降低帧数或优化擦除面积。

---

## 后续扩展

- **Ease 曲线**：可用 `progress^2`, `sin`, `expo` 等实现更自然的缓入缓出。
- **GPU 加速**：若后续移植到支持 DMA 的显示库，可考虑硬件滚动窗口替代逐像素刷。
- **配置化**：将帧数、时长写入 `config.h` 便于快速调参。

---

> 如需进一步示例代码或调优建议，请在 issues 中 @我。 