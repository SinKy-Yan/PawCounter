# CLAUDE.md

此文件为Claude Code (claude.ai/code)在处理此代码库时提供指导。

## 项目概述

这是一个基于ESP32-S3的计算器项目，使用PlatformIO开发。硬件特性包括：
- ESP32-S3 DevKit-M-1开发板
- 480x128 LCD显示屏，带背光控制
- 22键物理键盘，每个按键都有独立LED反馈
- 电池管理系统（MAX17048电量计 + TP4056充电器）
- 蜂鸣器音频反馈
- WS2812 RGB LED用于按键照明

## 构建命令

```bash
# 编译项目
/mnt/c/.platformio/penv/Scripts/pio.exe run

# 上传到设备
/mnt/c/.platformio/penv/Scripts/pio.exe run --target upload

# 监控串口输出
/mnt/c/.platformio/penv/Scripts/pio.exe device monitor

# 清理构建文件
/mnt/c/.platformio/penv/Scripts/pio.exe run --target clean

# 一键编译并上传
/mnt/c/.platformio/penv/Scripts/pio.exe run --target upload --target monitor
```

## 架构概览

### 核心组件

项目采用模块化架构，包含以下主要组件：

1. **硬件抽象层**
   - `config.h`: 硬件配置和引脚定义的中心
   - `Initialization.h/.cpp`: 显示屏、LED、动画的硬件初始化例程

2. **输入系统**
   - `KeypadControl`: 高级键盘管理，支持防抖、长按检测、自动重复、LED反馈和蜂鸣器
   - 使用移位寄存器扫描22个物理按键
   - 支持组合键和多种事件类型（按下/释放/长按/重复）

3. **显示系统**  
   - 使用Arduino_GFX库进行LCD控制
   - 480x128像素显示屏，支持自定义字体（`FreeSansBold10pt7b.h`）
   - `BackLightControl`: 基于PWM的背光控制，支持平滑渐变

4. **电源管理**
   - `BatteryManager`: MAX17048电量计集成，用于电压/电量百分比监控
   - TP4056充电电路状态监控
   - 低电量检测和警告

5. **应用逻辑**
   - `Calculator`: 主计算器引擎，包含显示缓冲区管理、算术运算和按键映射
   - 处理数字输入、运算符、小数点和结果计算

6. **日志系统**
   - `Logger`: 基于ESP32-IDF的统一日志管理系统
   - 支持多级别日志（ERROR, WARN, INFO, DEBUG, VERBOSE）
   - 模块化标签管理，便于调试和监控
   - 可配置的输出格式和彩色显示

7. **新一代计算器系统（v2.0）**
   - `CalculatorCore`: 可扩展的计算器核心架构
   - `CalculatorDisplay`: 双重显示系统（LCD + 串口同步输出）
   - `CalculationEngine`: 高精度计算引擎，支持自定义函数
   - `CalculatorModes`: 可插拔的计算模式系统（基本、科学、财务等）
   - 完整的计算历史追踪和错误处理

### 关键设计模式

- **单例模式**: `BacklightControl`和`Logger`使用单例模式便于全局访问
- **事件驱动架构**: `KeypadControl`使用回调系统处理按键事件
- **硬件抽象**: 所有引脚定义集中在`config.h`中
- **状态管理**: 每个组件维护自己的状态并具有更新循环
- **模块化日志**: 每个组件使用专用的日志标签，便于调试和监控

### 硬件集成

系统集成了多个硬件子系统：
- **SPI显示**: LCD的自定义并行接口
- **移位寄存器扫描**: 键盘矩阵的串行输入
- **I2C电池监控**: MAX17048通信
- **PWM控制器**: 用于背光、蜂鸣器和LED效果的LEDC
- **RMT协议**: 通过FastLED控制WS2812 LED灯带

### 按键映射

物理按键通过`LED_TO_KEY_MAP`和`KEY_MATRIX`数组进行映射。计算器支持：
- 标准数字输入（0-9）
- 基本运算符（+、-、*、/）
- 特殊功能（清除、等号、小数点）
- 电源和蓝牙按键（预留扩展）

## 开发注意事项

- 所有时间敏感操作使用`millis()`进行非阻塞执行
- 硬件初始化必须遵循特定顺序（显示屏 → LED → 键盘 → 电池）
- 主循环需要定期调用各组件的`update()`方法以确保正常运行
- 在config.h中定义`DEBUG_MODE`时可获得调试输出
- 使用新的ESP32 LEDC API：`ledcAttach()`、`ledcAttachChannel()`、`ledcWrite()`，而不是已弃用的`ledcSetup()`和`ledcAttachPin()`

## 日志系统使用

项目集成了完整的日志管理系统：

### 日志级别
- **ERROR**: 错误信息，系统异常
- **WARN**: 警告信息，潜在问题
- **INFO**: 重要信息，系统状态
- **DEBUG**: 调试信息，详细流程
- **VERBOSE**: 详细信息，完整数据

### 模块标签
- `MAIN`: 主程序
- `KEYPAD`: 键盘控制
- `DISPLAY`: 显示系统
- `BACKLIGHT`: 背光控制
- `BATTERY`: 电池管理
- `CALC`: 计算器逻辑
- `SYSTEM`: 系统日志

### 便捷宏
```cpp
// 通用日志宏
LOG_E(TAG_KEYPAD, "Error message");
LOG_W(TAG_KEYPAD, "Warning message");
LOG_I(TAG_KEYPAD, "Info message");
LOG_D(TAG_KEYPAD, "Debug message");
LOG_V(TAG_KEYPAD, "Verbose message");

// 模块专用宏
KEYPAD_LOG_I("Key %d pressed", keyNum);
DISPLAY_LOG_D("Backlight set to %d%%", brightness);
BATTERY_LOG_W("Low battery: %d%%", percentage);
```

### 串口控制命令
发送以下字符到串口可控制日志系统：
- `t/T`: 触发键盘位状态测试
- `l/L`: 设置日志级别为VERBOSE
- `i/I`: 设置日志级别为INFO
- `d/D`: 设置日志级别为DEBUG
- `e/E`: 设置日志级别为ERROR

## 键盘扫描调试

集成了详细的键盘扫描调试功能：
- 使用日志系统输出按键事件（INFO级别）
- 原始扫描状态输出（VERBOSE级别）
- 详细的位状态检查（VERBOSE级别）
- 按键映射和硬件状态诊断

## 故障排除

如果遇到按键响应问题：
1. 检查串口监视器中的调试输出
2. 使用't'命令测试所有位状态
3. 验证`KEY_POSITIONS`数组与实际硬件连接是否匹配
4. 确保主循环中没有长时间阻塞操作

## 新一代计算器系统（v2.0）

项目包含了完全重新设计的可扩展计算器架构，具有以下特点：

### 核心架构

#### CalculatorCore（计算器核心）
- **职责**: 统一的计算器控制中心
- **功能**: 按键处理、状态管理、模式切换、历史记录
- **特点**: 可扩展、模块化、高内聚低耦合

#### CalculatorDisplay（显示管理）
- **双重输出**: 同时支持LCD屏幕和串口终端显示
- **智能格式化**: 根据数字大小自动选择最佳显示格式
- **主题支持**: 可配置的颜色、字体和布局
- **实时同步**: LCD和串口内容完全同步显示

#### CalculationEngine（计算引擎）
- **高精度**: 支持多种精度级别（标准、高精度、财务、科学）
- **可扩展**: 支持自定义数学函数注册
- **错误处理**: 完善的计算错误检测和报告
- **内置函数**: sin, cos, tan, log, exp, pow, abs, factorial等

#### CalculatorModes（计算模式）
- **基本模式**: 四则运算、百分比、平方根等
- **科学模式**: 三角函数、对数、指数、角度转换
- **财务模式**: 货币格式、单位显示、金额分解
- **程序员模式**: 进制转换、位运算（预留）

### 财务模式特色功能

#### 单位显示系统
```cpp
// 自动显示数字的中文单位
12345.67 显示为:
- LCD: ¥12,345.67 [万位指示]
- 串口: 
  总金额: ¥12,345.67
  1 万
  2 千
  3 百
  4 十
  5 个
  0.67 元
```

#### 财务专用格式化
- **千位分隔符**: 自动添加逗号分隔
- **货币符号**: 支持多种货币显示
- **小数精度**: 财务模式固定2位小数
- **负数处理**: 特殊的负数显示格式

### 使用方法

#### 编译选择
```bash
# 使用原版计算器（简单版）
/mnt/c/.platformio/penv/Scripts/pio.exe run

# 使用新版计算器（可扩展版）
# 将 main_calculator.cpp 重命名为 main.cpp
```

#### 串口命令系统
新版计算器提供了丰富的串口命令：

```
help/h         - 显示命令帮助
mode/m         - 切换计算模式（基本→财务→基本）
test           - 执行计算测试
financial      - 财务模式演示（展示不同金额的单位分解）
clear/c        - 清除显示内容
status/s       - 显示当前状态信息
keymap         - 按键映射测试（启动/关闭测试模式）
layout         - 显示按键布局图
```

#### 模式切换演示
```
输入: mode
输出: 切换到: 财务模式

输入: financial
输出: === 财务模式演示 ===
      小额示例: ¥1,234.56
        1 千
        2 百
        3 十
        4 个
        0.56 元
      
      中额示例: ¥98,765.43
        9 万
        8 千
        7 百
        6 十
        5 个
        0.43 元
```

### 扩展开发

#### 添加新的计算模式
1. 继承`CalculatorMode`基类
2. 实现必要的虚函数
3. 定义专用的按键映射
4. 注册到计算器核心

#### 添加自定义数学函数
1. 继承`CalculationFunction`基类
2. 实现`calculate()`方法
3. 通过`CalculationEngine::addFunction()`注册

#### 自定义显示格式
1. 创建新的`NumberFormat`配置
2. 设置`UnitDisplay`配置
3. 通过显示管理器应用

### 架构优势

1. **高度模块化**: 每个组件职责单一，便于维护
2. **易于扩展**: 新功能可以通过插件方式添加
3. **双重显示**: LCD和串口同步，便于调试和演示
4. **专业功能**: 财务模式的单位显示适合实际应用
5. **完整历史**: 所有计算都有详细记录
6. **错误处理**: 完善的错误检测和用户友好提示

## 最近修复和改进

### 2024-01-07 按键映射和计算逻辑修复

#### 问题解决
1. **按键映射混乱问题**:
   - 修复了 `CalculatorCore.cpp` 中 `_keyMappings[]` 数组的物理按键编号映射
   - 确保硬件按键编号（1-22）与功能定义正确对应
   - 添加了按键映射测试功能（`keymap` 命令）

2. **计算逻辑错误**:
   - 修复了运算符输入后数字拼接的问题（如 `1 + 1` 变成 `1 + 11` 的错误）
   - 改进了状态转换逻辑（INPUT_NUMBER → INPUT_OPERATOR → INPUT_NUMBER）
   - 修复了链式运算中 `_previousNumber` 更新错误
   - 完善了各种功能键的实现（DELETE、正负号、百分号等）

#### 新增调试功能
- **按键布局图**: `layout` 命令显示完整的22键布局
- **按键映射测试**: `keymap` 命令启动测试模式，实时显示按键详细信息
- **详细日志**: 添加了计算过程的详细调试日志

#### 按键布局确认
```
┌───────┬───────┬───────┬───────┬───────┐
│Key 1  │Key 6  │Key 10 │Key 15 │Key 19 │
│ON/OFF │  BT   │ PCT   │  C    │ DEL   │
├───────┼───────┼───────┼───────┼───────┤
│Key 2  │Key 7  │Key 11 │Key 16 │Key 20 │
│  7    │  8    │  9    │ MUL   │ +/-   │
├───────┼───────┼───────┼───────┼───────┤
│Key 3  │Key 8  │Key 12 │Key 17 │Key 21 │
│  4    │  5    │  6    │ SUB   │ DIV   │
├───────┼───────┼───────┼───────┼───────┤
│Key 4  │Key 9  │Key 13 │Key 18 │Key 22 │
│  1    │  2    │  3    │ ADD   │ EQ    │
├───────┼───────┼───────┴───────┴───────┤
│Key 5  │Key 14 │                       │
│  0    │  .    │                       │
└───────┴───────┴───────────────────────┘
```

#### 测试验证
- 基本四则运算：`1 + 1 = 2` ✓
- 链式运算：`1 + 2 + 3 = 6` ✓
- 小数运算：`1.5 * 2 = 3` ✓
- 功能键：清除、删除、正负号切换 ✓

### 故障排除更新
如果遇到按键或计算问题：
1. 使用 `layout` 命令查看按键布局
2. 使用 `keymap` 命令进入测试模式验证按键功能
3. 检查串口日志中的详细计算过程
4. 使用 `status` 命令查看当前状态信息